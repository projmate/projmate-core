// Generated by CoffeeScript 1.6.1
(function() {
  var Fs, Logger, PackageJson, Path, Program, Runner, Str, log, version;

  Fs = require("fs");

  Logger = require("../../dist/lib/common/logger");

  PackageJson = require("../../package.json");

  Path = require("path");

  Program = require("commander");

  Runner = require("../../dist/lib/pm-serve/runner");

  Str = require("underscore.string");

  log = Logger.getLogger("pm-serve");

  version = PackageJson.version;

  Program.version(version).option("-p, --port [PORT]", "HTTP port", 8000).option("-s, --ssl-port [HTTPS_PORT]", "HTTPS port", 4430).parse(process.argv);

  exports.run = function() {
    var cwd, executeTasks, proj, projfile, runner, tasks;
    try {
      tasks = Program.args.slice(1);
      projfile = findProjfile();
      log.debug(".\n  environment: " + Program.environment + "\n  projfile: " + projfile);
      runner = new Runner({
        program: Program
      });
      cwd = process.cwd();
      process.chdir(Path.dirname(projfile));
      proj = loadProjfile();
      if (!proj.project) {
        throw new Error("" + projfile + " does not export `project` function");
      }
      executeTasks = function(err) {
        if (err) {
          return log.error(err);
        }
        return runner.executeTasks(tasks, function(err) {
          if (err) {
            return log.error(err);
          }
        });
      };
      if (proj.project.length === 1) {
        proj.project(runner);
        return executeTasks();
      } else {
        return proj.project(runner, executeTasks);
      }
    } catch (e) {
      return log.error(e);
    }
  };

  exports.meta = {
    name: "serve",
    description: "Runs HTTP/HTTPS Server from Directory",
    quickUsage: function() {
      return "To serve current directory\n  pm serve\n\nBrowse\n  http://localhost:8000\n  https://localhost:4430";
    },
    usage: function(cb) {
      return cb("" + exports.meta.description + " (v" + version + ")\n\nUsage: pm serve [DIR=.] [OPTIONS]\n\nOPTIONS\n  -p, --port=8000     HTTP port.\n  -s, --ssl-port=4430 HTTPS port.\n  -k, --known-ports   Serve on known ports 80 and 443.\n\nEXAMPLES\n\nServe current directory using HTTP:8000 and HTTPS:4430 defaults\n  pm serve\n\nServe `dist` directory on port 80 and port 443\n  sudo pm serve dist -k");
    }
  };

}).call(this);
